name: Build FMOD Banks (Escolha Windows ou Linux)

on:
  workflow_dispatch:
    inputs:
      runner_os:
        description: "Runner (Windows ou Linux)"
        required: true
        default: "linux"
        type: choice
        options:
          - windows
          - linux

      fmod_package:
        description: "Pacote do FMOD Studio (do seu Release)"
        required: true
        default: "linux-deb"
        type: choice
        options:
          - win64-exe
          - linux-deb
          - linux-appimage

      release_tag:
        description: "Tag do Release no seu repo (onde estão os installers)"
        required: true
        default: "Va"

      win_asset_name:
        description: "Nome do asset do Windows no Release (EXE)"
        required: true
        default: "fmodstudio20302win64-installer.exe"

      deb_asset_name:
        description: "Nome do asset do Linux no Release (DEB)"
        required: true
        default: "fmodstudio20302linux64-installer.deb"

      appimage_asset_name:
        description: "Nome do asset do Linux no Release (AppImage)"
        required: true
        default: "fmodstudio20302linux64-installer.AppImage"

      fspro_path:
        description: "Caminho do .fspro no repo"
        required: true
        default: "celeste_audio.fspro"

      artifact_name:
        description: "Nome do artifact de saída"
        required: true
        default: "fmod-banks"

      extra_build_args:
        description: "Argumentos extras para o build (opcional)"
        required: false
        default: ""

jobs:
  windows:
    if: ${{ inputs.runner_os == 'windows' && inputs.fmod_package == 'win64-exe' }}
    runs-on: windows-latest
    env:
      FSPRO: ${{ inputs.fspro_path }}
      ARTIFACT: ${{ inputs.artifact_name }}
      INSTALL_DIR: C:\FMODStudio
      FMOD_URL: https://github.com/kiroayu576-ops/STUDIO-/releases/download/${{ inputs.release_tag }}/${{ inputs.win_asset_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download FMOD Studio installer (Windows)
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "$env:FMOD_URL" -OutFile "fmod_installer.exe"

      - name: Install FMOD Studio (best-effort silent strategies)
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "$env:INSTALL_DIR" | Out-Null

          $silentAttempts = @(
            @("/S", "/D=$($env:INSTALL_DIR)"),
            @("/SILENT"),
            @("/VERYSILENT"),
            @("/quiet"),
            @("/silent")
          )

          $installed = $false

          foreach ($args in $silentAttempts) {
            Write-Host "Tentando instalar com args: $($args -join ' ')"
            try {
              $p = Start-Process -FilePath ".\fmod_installer.exe" -ArgumentList $args -Wait -PassThru
            } catch {
              Write-Host "Falha ao executar installer com args atuais."
              continue
            }

            # Após cada tentativa, tenta localizar o exe
            $candidates = @(
              "$($env:INSTALL_DIR)\fmodstudio.exe",
              "$($env:INSTALL_DIR)\FMOD Studio\fmodstudio.exe",
              "C:\Program Files\FMOD SoundSystem\FMOD Studio\fmodstudio.exe",
              "C:\Program Files\FMOD SoundSystem\FMOD Studio 2.02\fmodstudio.exe",
              "C:\Program Files\FMOD SoundSystem\FMOD Studio 2.03\fmodstudio.exe"
            )

            foreach ($c in $candidates) {
              if (Test-Path $c) { $installed = $true; break }
            }

            if ($installed) { break }
          }

          if (-not $installed) {
            Write-Error "Não consegui instalar FMOD Studio em modo silencioso no runner público. Use Linux (deb) com Xvfb ou runner self-hosted."
          }

      - name: Locate fmodstudio.exe
        shell: powershell
        run: |
          $install = $env:INSTALL_DIR

          $candidates = @(
            "$install\fmodstudio.exe",
            "$install\FMOD Studio\fmodstudio.exe",
            "C:\Program Files\FMOD SoundSystem\FMOD Studio\fmodstudio.exe",
            "C:\Program Files\FMOD SoundSystem\FMOD Studio 2.02\fmodstudio.exe",
            "C:\Program Files\FMOD SoundSystem\FMOD Studio 2.03\fmodstudio.exe"
          )

          $exe = $null
          foreach ($p in $candidates) {
            if (Test-Path $p) { $exe = $p; break }
          }

          if (-not $exe) {
            $hits = Get-ChildItem -Path "C:\" -Recurse -ErrorAction SilentlyContinue -Filter "fmodstudio.exe" |
                    Select-Object -First 1
            if ($hits) { $exe = $hits.FullName }
          }

          if (-not $exe) {
            Write-Error "Não encontrei fmodstudio.exe após instalação."
          }

          "FMOD_EXE=$exe" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "FMOD_EXE=$exe"

      - name: Build banks (with clearer error on migration)
        shell: powershell
        run: |
          if (!(Test-Path $env:FSPRO)) { Write-Error ".fspro não encontrado: $env:FSPRO" }

          $args = "${{ inputs.extra_build_args }}".Trim()

          try {
            if ([string]::IsNullOrWhiteSpace($args)) {
              & $env:FMOD_EXE -build $env:FSPRO
            } else {
              & $env:FMOD_EXE -build $env:FSPRO $args
            }
          } catch {
            Write-Error "Falha ao buildar. Se aparecer 'Project is out of date and requires project migration', você precisa usar a versão EXATA do FMOD Studio que criou esse .fspro (sem migrar), ou migrar via UI e commitar o projeto."
          }

      - name: Collect banks (keeps folder structure)
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "out_banks" | Out-Null

          $banks = Get-ChildItem -Recurse -File -Filter "*.bank" | Where-Object {
            $_.FullName -notmatch "\\(Assets|Metadata|Plugins)\\"
          }

          if (!$banks -or $banks.Count -eq 0) {
            Write-Error "Nenhum .bank encontrado após o build. Verifique se o projeto está configurado para gerar banks."
          }

          $root = (Resolve-Path ".").Path
          foreach ($b in $banks) {
            $full = (Resolve-Path $b.FullName).Path
            $rel = $full.Substring($root.Length).TrimStart('\')
            $dest = Join-Path "out_banks" $rel
            $destDir = Split-Path -Parent $dest
            New-Item -ItemType Directory -Force -Path $destDir | Out-Null
            Copy-Item $b.FullName -Destination $dest -Force
          }

          $banks | Select-Object FullName, Length | Sort-Object Length -Descending | Format-Table -AutoSize

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT }}
          path: out_banks

  linux-deb:
    if: ${{ inputs.runner_os == 'linux' && inputs.fmod_package == 'linux-deb' }}
    runs-on: ubuntu-latest
    env:
      FSPRO: ${{ inputs.fspro_path }}
      ARTIFACT: ${{ inputs.artifact_name }}
      FMOD_URL: https://github.com/kiroayu576-ops/STUDIO-/releases/download/${{ inputs.release_tag }}/${{ inputs.deb_asset_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download FMOD Studio (.deb)
        run: |
          curl -L "$FMOD_URL" -o fmodstudio.deb

      - name: Install FMOD Studio (.deb)
        run: |
          sudo apt-get update
          sudo apt-get install -y ./fmodstudio.deb || sudo apt-get -f install -y

      - name: Install headless deps (Qt/XCB + Xvfb + Audio shim)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            pulseaudio \
            pulseaudio-utils \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xinput0 \
            libxcb-xfixes0 \
            libglib2.0-0 \
            libdbus-1-3

      - name: Start PulseAudio dummy (avoid hang)
        run: |
          pulseaudio -D --exit-idle-time=-1 || true
          pactl load-module module-null-sink sink_name=Dummy sink_properties=device.description=Dummy || true
          pactl set-default-sink Dummy || true
          pactl info || true
          pactl list short sinks || true

      - name: Locate fmodstudio
        run: |
          set -e
          if command -v fmodstudio >/dev/null 2>&1; then
            echo "FMOD_EXE=$(command -v fmodstudio)" >> $GITHUB_ENV
          else
            FOUND="$(sudo find / -maxdepth 6 -type f -name fmodstudio -perm -111 2>/dev/null | head -n 1 || true)"
            if [ -z "$FOUND" ]; then
              echo "Não encontrei o executável fmodstudio no Linux." >&2
              exit 1
            fi
            echo "FMOD_EXE=$FOUND" >> $GITHUB_ENV
          fi
          echo "FMOD_EXE=$FMOD_EXE"

      - name: Build banks (headless via Xvfb + PulseAudio env)
        run: |
          set -e
          if [ ! -f "$FSPRO" ]; then
            echo ".fspro não encontrado: $FSPRO" >&2
            exit 1
          fi

          EXTRA="${{ inputs.extra_build_args }}"
          if [ -z "$EXTRA" ]; then
            xvfb-run -a env PULSE_SERVER=127.0.0.1 "$FMOD_EXE" -build "$FSPRO"
          else
            xvfb-run -a env PULSE_SERVER=127.0.0.1 "$FMOD_EXE" -build "$FSPRO" $EXTRA
          fi

      - name: Collect banks (keeps folder structure)
        run: |
          set -e
          mkdir -p out_banks
          mapfile -t BANKS < <(find . -type f -name "*.bank" \
            ! -path "./Assets/*" ! -path "./Metadata/*" ! -path "./Plugins/*")

          if [ "${#BANKS[@]}" -eq 0 ]; then
            echo "Nenhum .bank encontrado." >&2
            exit 1
          fi

          for b in "${BANKS[@]}"; do
            rel="${b#./}"
            mkdir -p "out_banks/$(dirname "$rel")"
            cp -f "$b" "out_banks/$rel"
          done

          ls -lah out_banks || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT }}
          path: out_banks

  linux-appimage:
    if: ${{ inputs.runner_os == 'linux' && inputs.fmod_package == 'linux-appimage' }}
    runs-on: ubuntu-latest
    env:
      FSPRO: ${{ inputs.fspro_path }}
      ARTIFACT: ${{ inputs.artifact_name }}
      FMOD_URL: https://github.com/kiroayu576-ops/STUDIO-/releases/download/${{ inputs.release_tag }}/${{ inputs.appimage_asset_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download FMOD Studio (AppImage)
        run: |
          curl -L "$FMOD_URL" -o fmodstudio.AppImage
          chmod +x fmodstudio.AppImage

      - name: Install headless deps (Qt/XCB + Xvfb + Audio shim + FUSE libs)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            pulseaudio \
            pulseaudio-utils \
            libfuse2 \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xinput0 \
            libxcb-xfixes0 \
            libglib2.0-0 \
            libdbus-1-3

      - name: Start PulseAudio dummy (avoid hang)
        run: |
          pulseaudio -D --exit-idle-time=-1 || true
          pactl load-module module-null-sink sink_name=Dummy sink_properties=device.description=Dummy || true
          pactl set-default-sink Dummy || true
          pactl info || true
          pactl list short sinks || true

      - name: Extract AppImage (avoid FUSE requirement on runners)
        run: |
          set -e
          ./fmodstudio.AppImage --appimage-extract
          test -d squashfs-root
          test -x squashfs-root/AppRun

      - name: Build banks (AppImage extracted headless via Xvfb + PulseAudio env)
        run: |
          set -e
          if [ ! -f "$FSPRO" ]; then
            echo ".fspro não encontrado: $FSPRO" >&2
            exit 1
          fi

          EXTRA="${{ inputs.extra_build_args }}"
          if [ -z "$EXTRA" ]; then
            xvfb-run -a env PULSE_SERVER=127.0.0.1 ./squashfs-root/AppRun -build "$FSPRO"
          else
            xvfb-run -a env PULSE_SERVER=127.0.0.1 ./squashfs-root/AppRun -build "$FSPRO" $EXTRA
          fi

      - name: Collect banks (keeps folder structure)
        run: |
          set -e
          mkdir -p out_banks
          mapfile -t BANKS < <(find . -type f -name "*.bank" \
            ! -path "./Assets/*" ! -path "./Metadata/*" ! -path "./Plugins/*")

          if [ "${#BANKS[@]}" -eq 0 ]; then
            echo "Nenhum .bank encontrado." >&2
            exit 1
          fi

          for b in "${BANKS[@]}"; do
            rel="${b#./}"
            mkdir -p "out_banks/$(dirname "$rel")"
            cp -f "$b" "out_banks/$rel"
          done

          ls -lah out_banks || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT }}
          path: out_banks

